#图片处理平台详细设计
##1.	指令设计

* 指令格式：参考七牛云存储指令
	
	* 请求样例：http://ff-app-cms.pingan.com.cn/dmz/fimage/app.png?imageView/w/960/h/540/quality/70
	* imageView为指令名称，w/960/h/540/quality/70为指令参数，/fimage/app.png为图片路径
* 设计模式：根据指令格式确定设计模式 
![Alt text](/Users/tiancong771/Desktop/Hello-World/order.png)
每一个指令对应一个指令类(imageView对应ImageViewOperation)，通过解析请求uri获取指令名称,然后通过spring容器创建对应的指令类，以后新增指令只需新增一个指令类即可，其他代码无需改动，方便拓展。


##2.	图片处理软件选型

* 业界两款主流图片处理软件imagemagick，graphicsmagick，imagemagick有java api JMagick的支持，而graphicsmagick不支持java，故选择imagemagick

* mageMagick是免费软件：全部源码开放，支持90种以上图片格式




##3.	并发控制设计
由于图片处理一般较为耗时且cpu占用率较高，为了防止内存溢出以及对应用其他业务的影响，所以必须对图片处理进行严格并发控制。<br>

方案设计：

* 每台服务器并发进行图片处理线程不能大于5 (并发数可以配置)
* 如果服务器当前并发图片处理线程数大于5，新的图片处理请求线程如果未匹配到缓存不进行图片处理直接返回原图并将图片处理请求加入图片处理任务队列
* 定时任务读取图片处理任务队列中的任务进行处理并将结果存入缓存

流程图：
![Alt text](/Users/tiancong771/Desktop/Hello-World/图片处理并发控制.png)

##4.	缓存方案设计


###4.1	图片缓存内存占用大小分析


大小分析：

* 2016运营图片不超过10M(参照淦哥评估)
* 按平均每张图片存在20种处理请求计算，10x20=200M，所以图片缓存内存占用最大为200M

分析结论：

* 前期运营图片较少，缓存占用内存开销小，所有图片处理结果可以全部缓存到内存
* 每种图片处理请求基本只要第一次请求进行图片处理产生缓存，以后再次请求都能命中缓存，不需要再次进行图片处理
* 与采用nginx方案分析对比
	* 虽然nginx访问静态资源平均性能是tomcat的6-10倍，但是采用缓存方案以后， 每种图片处理请求基本只在第一次请求时需要进行图片处理和io操作，以后都能命中缓存，nginx每次请求都需要io操作，而内存读取速度是磁盘读取速度100倍以上，所以在小容量图片资源情况下，tomcat+缓存方案访问图片性能觉不亚与nginx，甚至高于nginx。

	


###4.2 方案一：redis缓存
方案设计:

* 使用redis缓存图片，redis缓存图片内存占用最大200M(可以配置)
* 利用redis某个key记录图片缓存在redis中占用内存大小
* 清理redis缓存
	* 定时任务清理缓存
		* 缓存大于200M才清理
		* 自定义算法进行清理(LRU，随机)
	* 调用接口强制清理缓存

方案缺点：

* redis内存小(1G)，所以图片缓存大小受限
* 缓存清理算法需要自行实现

方案优点：

* 重启tomcat缓存不会丢失



###4.3 方案二：本地缓存+redis消息同步

方案设计:

* 应用内存缓存图片，缓存图片内存占用不超过200-500M(可以配置)
* 通过redis发布订阅模式同步各个应用节点的缓存
* 缓存清理利用JAVA LRU框架以及调用接口强制清理

方案缺点：

* 重启tomcat会导致缓存丢失(运管平台重启应用不会丢失缓存)
* 各个节点应用缓存需要同步(代价很小)

方案优点：

* 服务器内存大(8G)，缓存图片内存占用可以适当调高
* 本地缓存读取速度更快
* 缓存管理可以利用成熟的JAVA LRU框架



